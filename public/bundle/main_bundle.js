(()=>{"use strict";const e=new class{#e;constructor(){this.#e={}}on(e,t){this.#e[e]=this.#e[e]||[],this.#e[e].includes(t)||this.#e[e].push(t)}off(e,t){this.#e[e]=this.#e[e].filter((e=>e!==t))}emit(e,t){this.#e[e]?this.#e[e].forEach((e=>e(t))):console.error(e)}add(e){e.forEach((({event:e,callback:t})=>{Array.isArray(t)?t.forEach((t=>{this.on(e,t)})):this.on(e,t)}))}delete(e){e.forEach((({event:e,callback:t})=>{Array.isArray(t)?t.forEach((t=>{this.off(e,t)})):this.off(e,t)}))}},t="visible",s="hidden",n=t=>{document.getElementById("alert-label").style.visibility="hidden",document.getElementById("register-href").addEventListener("click",(t=>{t.preventDefault(),e.emit("signup click")})),t.addEventListener("submit",(s=>{s.preventDefault();const n=t.getElementsByClassName("login")[0],a=t.getElementsByClassName("password")[0],i={username:n.value.trim(),password:a.value.trim()};e.emit("signin submit",i)}))};async function a({context:e,url:t}){const s=await(({url:e})=>(({url:e,fileExtention:t})=>new Promise(((s,n)=>{new RegExp(`.(${t})$`).test(e)&&s(e),n(new Error("wrong file extention"))})))({fileExtention:"handlebars",url:e}).then((()=>(({url:e})=>fetch(e).then((e=>{if(!e.ok)throw new Error(e.statusText);return e.text()})))({url:e}))))({url:t});return(({templateHTML:e,context:t})=>Handlebars.compile(e)(t))({templateHTML:s,context:e})}class i{element;#t=this.constructor.name;get(){return this.element}constructor(e){this.element=e}isActive(){return"visible"===this.element.style.visibility||"hidden"!==this.element.style.visibility&&void 0}hide(){this.element.children[0].style.visibility="hidden",this.element.children[0].hidden=!0}show(){this.element.children[0].style.visibility="visible",this.element.children[0].hidden=!1}delete(){this.element.innerHTML=""}}class r{static signUp({username:e,email:t,password:s,repassword:n}){return s&&n&&e&&t?t.match(/@/)?s.match(/^\S{4,}$/)?s!==n?"Пароли не одинаковые":void 0:"Неверный формат пароля":"Неверный формат электронной почты":"Заполните все поля"}static signIn({username:e,password:t}){return e&&t?t.match(/^\S{4,}$/)?void 0:"Неверный формат пароля":"Заполните все поля"}}const o=new class{email;username;set({email:e,username:t}){this.email=e,this.username=t}delete(){this.email=void 0,this.username=void 0}},c=()=>{const e=document.getElementsByClassName("login")[0],t=document.getElementsByClassName("password")[0];e.value="",t.value=""},l=e=>{const t=document.getElementById("alert-label");t.innerText=e,t.style.visibility="visible"},d=()=>{document.getElementById("alert-label").style.visibility="hidden"},m=[{event:"signup click",callback:[c,d,()=>{e.emit("signup state request")}]},{event:"signin submit",callback:[t=>{const s=r.signIn(t);s?e.emit("signin validation fail",s):e.emit("signin validation success",t)}]},{event:"signin validation success",callback:[d,t=>{e.emit("signin ajax request",t)}]},{event:"signin validation fail",callback:[l]},{event:"signin success",callback:[c,e=>{try{const t=JSON.parse(e);o.set(t),console.log(o)}catch(e){console.error(e)}},()=>{e.emit("show saved state")}]},{event:"signin fail",callback:e=>{try{const t=JSON.parse(e);l(t["error description"])}catch(e){console.error(e)}}}],u=t=>{document.getElementById("alert-label").style.visibility="hidden",document.getElementById("signin-href").addEventListener("click",(t=>{t.preventDefault(),e.emit("signin click")})),t.addEventListener("submit",(s=>{s.preventDefault();const n=t.getElementsByClassName("login")[0],a=t.getElementsByClassName("email")[0],i=t.getElementsByClassName("password")[0],r=t.getElementsByClassName("repassword")[0],o={username:n.value.trim(),email:a.value.trim(),password:i.value.trim(),repassword:r.value.trim()};e.emit("signup submit",o)}))},h=()=>{document.getElementById("alert-label").style.visibility="hidden"},p=()=>{const e=document.getElementsByClassName("login")[0],t=document.getElementsByClassName("email")[0],s=document.getElementsByClassName("password")[0],n=document.getElementsByClassName("repassword")[0];e.value="",t.value="",s.value="",n.value=""},g=e=>{const t=document.getElementById("alert-label");t.innerText=e,t.style.visibility="visible"},f=[{event:"signin click",callback:[p,h,()=>{e.emit("signin state request")}]},{event:"signup submit",callback:[t=>{const s=r.signUp(t);s?e.emit("signup validation fail",s):e.emit("signup validation success",t)}]},{event:"signup validation success",callback:[h,t=>{e.emit("signup ajax request",t)}]},{event:"signup validation fail",callback:[g]},{event:"signup success",callback:[p,e=>{try{const t=JSON.parse(e);o.set(t),console.log(o)}catch(e){console.error(e)}},()=>{e.emit("show previous state")}]},{event:"signup fail",callback:e=>{try{const t=JSON.parse(e);g(t["error description"])}catch(e){console.error(e)}}}],v=t=>{t.getElementsByClassName("logo")[0].addEventListener("click",(t=>{t.preventDefault(),e.emit("logo button click")})),t.getElementsByClassName("profile-href")[0].addEventListener("click",(t=>{t.preventDefault(),e.emit("profile button click")})),t.getElementsByClassName("cart-href")[0].addEventListener("click",(t=>{t.preventDefault(),e.emit("cart-click")}))},k=[{event:"logo button click",callback:[()=>{e.emit("homepage state request")}]},{event:"profile button click",callback:[()=>{e.emit("profile state request")}]},{event:"cart-click",callback:[()=>{e.emit("showView",{name:"Cart"})}]}],b=t=>{e.emit("homepage ajax request")},x=({element:t,context:s})=>{t.getElementsByClassName("productName-href")[0].addEventListener("click",(t=>{t.preventDefault(),e.emit("productName-href click",s.id)})),t.getElementsByClassName("productImg-href")[0].addEventListener("click",(t=>{t.preventDefault(),e.emit("productImg-href click",s.id)}))},y=t=>{e.emit("product state request",t)},w=[{event:"productName-href click",callback:[y]},{event:"productImg-href click",callback:[y]}];class E extends i{#s="./productCard/template.handlebars";element;#n;#a=x;constructor(e){super(e),this.element=e}setContext(e){this.#n=e}async#i(){const e=await a({url:this.#s,context:this.#n});this.element.innerHTML=e,this.element.setAttribute("name",this.#n.id)}#r(){const e=this.element.getElementsByClassName("rating")[0],t=document.createElement("div");var s;t.className="rating",t.innerHTML=(s=this.#n.rating)?`\n        <div class="rating">\n        <span> <i class="${s>=1?"fa fa-star":s>=.5?"fa fa-star-half-o":"fa fa-star-o"}"></i></span> \n        <span> <i class="${s>=2?"fa fa-star":s>=1.5?"fa fa-star-half-o":"fa fa-star-o"}"></i></span> \n        <span> <i class="${s>=3?"fa fa-star":s>=2.5?"fa fa-star-half-o":"fa fa-star-o"}"></i></span> \n        <span> <i class="${s>=4?"fa fa-star":s>=3.5?"fa fa-star-half-o":"fa fa-star-o"}"></i></span> \n        <span> <i class="${s>=5?"fa fa-star":s>=4.5?"fa fa-star-half-o":"fa fa-star-o"}"></i></span>\n        </div>\n        `:"<div></div>",e.replaceWith(t)}async render(){return await this.#i(),e.add(w),this.#a({element:this.element,context:this.#n}),this.#r(),this.show()}delete(){this.element.innerHTML=""}}let T={};const L=e=>{if(T[e.id])return;const n=document.getElementsByClassName("product-container")[0],a=document.createElement("div");a.className="product-card";const i=new E(a);var r;r={[e.id]:{element:a,object:i,state:s}},T=Object.assign(T,r),i.setContext(e),T[e.id].state=t,n.appendChild(a),i.render().catch((e=>console.error(e)))},H=e=>{Array.isArray(e)?e.forEach((e=>{L(e)})):console.error("wrong prodArray")},M=[{event:"renderProdCard",callback:[L]},{event:"renderProdArray",callback:[H]},{event:"homepageLoaded",callback:[t=>{console.log("homepageLoaded"),console.log(t);try{const s=JSON.parse(t);H(s),e.emit("showView",{name:"Homepage"})}catch{console.error()}}]},{event:"homepage response",callback:[e=>{const t=JSON.parse(e);H(t)}]}],C=t=>{console.log("productEvents"),t.getElementsByClassName("back-to-result")[0].addEventListener("click",(t=>{t.preventDefault(),e.emit("backToResult click")})),t.getElementsByClassName("fw add-button primary")[0].addEventListener("click",(t=>{t.preventDefault(),e.emit("cart click")}))},N=new class{getCartItems=()=>localStorage.getItem("cartItems")?JSON.parse(localStorage.getItem("cartItems")):[];setCartItems=e=>{localStorage.setItem("cartItems",JSON.stringify(e))}},q=[{event:"backToResult click",callback:[]},{event:"cart click",callback:()=>{e.emit("product context request")}},{event:"product context response",callback:e=>{try{e.numbers[213];const t=e.find((e=>e.product===item.product));e=t?e.map((e=>e.product===t.product?item:e)):[...e,item],N.setCartItems(e),console.log(N.getCartItems().length)}catch(e){console.error(e)}}}],B=t=>{t.getElementsByClassName("update-button")[0].addEventListener("click",(t=>{t.preventDefault(),e.emit("update click")})),t.getElementsByClassName("signout-button")[0].addEventListener("click",(t=>{t.preventDefault(),e.emit("logout")}))},$=[{event:"update click",callback:[()=>{document.getElementsByName("login")[0].value.trim(),console.log(o)}]},{event:"logout",callback:[()=>{e.emit("signout ajax request")}]}],S=t=>{t.getElementsByClassName("primary fw")[0].addEventListener("click",(t=>{t.preventDefault(),e.emit("order click")}))},I=[{event:"order click",callback:[()=>{e.emit("showView",{name:"Order"})}]}],j={Signin:class extends i{#s="./signin/template.handlebars";element;#n;#a=n;constructor(e){super(e),this.element=e}async#i(){const e=await a({url:this.#s,context:this.#n});this.element.innerHTML=e}async render(){return await this.#i(),e.add(m),this.#a(this.element),this.show()}delete(){e.delete(m),this.element.innerHTML=""}},Signup:class extends i{#s="./signup/template.handlebars";element;#n;#a=u;constructor(e){super(e),this.element=e}async#i(){const e=await a({url:this.#s,context:this.#n});this.element.innerHTML=e}async render(){return await this.#i(),e.add(f),this.#a(this.element),this.show()}delete(){this.element.innerHTML=""}},Hood:class extends i{#n;#s="./hood/template.handlebars";element;#a=v;constructor(e){super(e),this.element=e}async#i(){const e=await a({url:this.#s,context:this.#n});this.element.innerHTML=e}setContext(e){this.#n=e}async render(){return await this.#i(),e.add(k),this.#a(this.element),this.show()}delete(){e.delete(k),this.element.innerHTML=""}hide(){this.element.style.visibility="hidden",this.element.hidden=!0}show(){this.element.style.visibility="visible",this.element.hidden=!1}},Homepage:class extends i{#s="./homepage/template.handlebars";element;#n;#a=b;constructor(e){super(e),this.element=e}async#i(){const e=await a({url:this.#s,context:this.#n});this.element.innerHTML=e}async render(){return await this.#i(),e.add(M),this.#a(this.element),this.show()}delete(){this.element.innerHTML=""}},Product:class extends i{#s="./product/template.handlebars";element;#n;#a=C;constructor(e){super(e),this.element=e}setContext(e){this.#n=e}getContext(){return this.#n}async#i(){const e=await a({url:this.#s,context:this.#n});this.element.innerHTML=e}#r(){const e=this.element.getElementsByClassName("rating")[0],t=document.createElement("div");var s;t.className="rating",t.innerHTML=(s=this.#n.rating)?`\n        <div class="rating">\n        <span> <i class="${s>=1?"fa fa-star":s>=.5?"fa fa-star-half-o":"fa fa-star-o"}"></i></span> \n        <span> <i class="${s>=2?"fa fa-star":s>=1.5?"fa fa-star-half-o":"fa fa-star-o"}"></i></span> \n        <span> <i class="${s>=3?"fa fa-star":s>=2.5?"fa fa-star-half-o":"fa fa-star-o"}"></i></span> \n        <span> <i class="${s>=4?"fa fa-star":s>=3.5?"fa fa-star-half-o":"fa fa-star-o"}"></i></span> \n        <span> <i class="${s>=5?"fa fa-star":s>=4.5?"fa fa-star-half-o":"fa fa-star-o"}"></i></span>\n        </div>\n        `:"<div></div>",e.replaceWith(t)}#o(){const e=this.element.getElementsByClassName("status")[0],t=document.createElement("div");t.className="status",t.innerHTML=this.#n.count_in_stock>0?'\n        Статус: <span class="success">В наличии</span>\n        ':'\n        Статус: <span class="error">Нет в наличии</span>\n        ',e.replaceWith(t)}async render(){return await this.#i(),e.add(q),this.#a(this.element),this.#r(),this.#o(),console.log(N.getCartItems().length),this.show()}delete(){this.element.innerHTML=""}},Profile:class extends i{#s="./profile/template.handlebars";element;#n;#a=B;constructor(e){super(e),this.element=e}async#i(){const e=await a({url:this.#s,context:this.#n});this.element.innerHTML=e}async render(){return await this.#i(),e.add($),this.#a(this.element),this.show()}delete(){this.element.innerHTML=""}},Cart:class extends i{#s="./cart/template.handlebars";element;#n;#a=S;constructor(e){super(e),this.element=e}async#i(){const e=await a({url:this.#s,context:this.#n});this.element.innerHTML=e}async render(){return await this.#i(),e.add(I),this.#a(this.element),this.show()}delete(){this.element.innerHTML=""}},Order:class extends i{#s="./order/template.handlebars";element;#n;constructor(e){super(e),this.element=e}async#i(){const e=await a({url:this.#s,context:this.#n});this.element.innerHTML=e}#c(){const e=this.element.getElementsByClassName("steps")[0],t=document.createElement("div");var s;t.className="steps",t.innerHTML=`\n      <div class="steps">\n      <div class="${(s=this.#n.step)?"active":""}">Signin</div>\n      <div class="${s?"active":""}">Shipping</div>\n      <div class="${s?"active":""}">Payment</div>\n      <div class="${s?"active":""}">Place Order</div>\n    </div>\n        `,e.replaceWith(t)}async render(){return await this.#i(),this.#c(),this.show()}delete(){this.element.innerHTML=""}}};let D={},O="";const P=e=>{D=Object.assign(D,e)},A=e=>{const n=document.getElementById("main-container");D[e]&&D[e].state===s&&(D[e].element.show(),D[e].state=t,n.replaceWith(D[e].dom)),Object.keys(D).forEach((t=>{t!==e&&"Hood"!==t&&(D[t].element.hide(),D[t].state=s)}))},J=()=>{e.emit("showView",{name:"Homepage"})},R=e=>{console.log(e),o.username=e,console.log(o)};let V="";const W=()=>{V||(V="homepage");const t=V.match(/(\D+)/);console.log("reg exp",t[1]);const s=V.match(/\D+(\d+)/);s?(console.log("reg exp",s[1]),e.emit(`${t[1]} state request`,s[1])):e.emit(`${t[1]} state request`)},z=t=>{e.emit("history add",t)},U=[{event:"showView",callback:[({name:e,context:n})=>{console.log(`${e} view`);let a=e;return n?.id&&(a+=n.id),D[a]?A(a):(({name:e,context:n})=>{const a=document.getElementById("main-container"),i=document.createElement("main");i.id="main-container";const r=new j[e](i);let o=e;return n?.id&&(o+=n.id),P({[o]:{element:r,dom:i,state:s}}),D[o].state=t,console.log(a),a.replaceWith(D[o].dom),D[o].element?.setContext&&D[o].element.setContext(n),D[o].element.render()})({name:e,context:n}).then((()=>A(a)))}]},{event:"logout success",callback:[W,()=>{o.delete()}]},{event:"homepage state request",callback:[()=>{e.emit("homepage state confirmed","homepage")}]},{event:"homepage state confirmed",callback:[()=>{J(),O="homepage"},z]},{event:"hompage state denied",callback:[()=>{console.error("homepage state denied")}]},{event:"profile state request",callback:[()=>{V=O},()=>{o.username?e.emit("authorization",o):e.emit("profile ajax request")}]},{event:"no authorization",callback:[()=>{e.emit("profile state denied")}]},{event:"authorization",callback:[()=>{e.emit("profile state confirmed","profile")}]},{event:"profile state denied",callback:[()=>{e.emit("signin state request")}]},{event:"profile state confirmed",callback:[()=>{e.emit("showView",{name:"Profile"}),O="profile"},z]},{event:"signin state request",callback:[()=>{if(o.username)return void e.emit("signin state denied");let t;const s=({responseText:n})=>{R(n),e.emit("signin state denied"),e.off("cookie check success",s),e.off("cookie check fail",t)};e.on("cookie check success",s),t=()=>{e.emit("signin state confirmed","signin"),e.off("cookie check success",s),e.off("cookie check fail",t)},e.on("cookie check fail",t),e.emit("cookie check request")}]},{event:"signin state confirmed",callback:[()=>{e.emit("showView",{name:"Signin"}),O="signin"},z]},{event:"signin state denied",callback:[()=>{console.error("signin state denied"),e.emit("homepage state request")}]},{event:"cookie check success",callback:[R]},{event:"cookie check fail",callback:[()=>{}]},{event:"signup state request",callback:[()=>{if(o.username)return void e.emit("signup state denied");let t;const s=({responseText:n})=>{R(n),e.emit("signup state denied"),e.off("cookie check success",s),e.off("cookie check fail",t)};e.on("cookie check success",s),t=()=>{e.emit("signup state confirmed","signup"),e.off("cookie check success",s),e.off("cookie check fail",t)},e.on("cookie check fail",t),e.emit("cookie check request")}]},{event:"signup state confirmed",callback:[()=>{e.emit("showView",{name:"Signup"}),O="signup"},z]},{event:"signup state denied",callback:[()=>{console.error("signup state denied"),e.emit("homepage state request")}]},{event:"product state request",callback:[t=>{let s;const n=({responseText:t})=>{e.emit("product state confirmed",t),e.off("product request success",n),e.off("product request fail",s)};e.on("product request success",n),s=({responseText:t})=>{e.emit("product state denied",t),e.off("product request success",n),e.off("product request fail",s)},e.on("product request fail",s),e.emit("product ajax request",t)},t=>{e.emit("history add",`product?id=${t}`)}]},{event:"product state confirmed",callback:[t=>{console.log("productStateConfirmed"),(t=>{const s=JSON.parse(t);console.log(t),e.emit("showView",{name:"Product",context:s})})(t),console.log(t.match(/."id":(\d*)/)[1]),O=`product${t.match(/."id":(\d*)/)[1]}`}]},{event:"product state denied",callback:[e=>{console.log("productStateDenied",e),J(),O="homepage"}]},{event:"show saved state",callback:[W]},{event:"product context request",callback:[()=>{const t=O[0].toUpperCase()+O.slice(1),s=D[t].element;e.emit("product context response",s.getContext())}]}];class G{static#l({method:e="GET",url:t="/",body:s=null,callback:n=(()=>{})}){const a=new XMLHttpRequest;if(a.open(e,t,!0),a.withCredentials=!0,a.addEventListener("readystatechange",(()=>{a.readyState===XMLHttpRequest.DONE&&n(a.status,a.responseText)})),s)return a.setRequestHeader("Content-type","application/json; charser=utf8"),void a.send(JSON.stringify(s));a.send()}static get(e={}){return new Promise(((t,s)=>{this.#l({...e,method:"GET",callback:(e,n)=>{e<300?t({status:e,responseText:n}):s({status:e,responseText:n})}})}))}static post(e={}){return new Promise(((t,s)=>{this.#l({...e,method:"POST",callback:(e,n)=>{e<300?t({status:e,responseText:n}):s({status:e,responseText:n})}})}))}}const X="https://ozonback.herokuapp.com",_=[{event:"signin ajax request",callback:t=>{console.log(t),G.post({url:`${X}/login`,body:t}).then((({responseText:t})=>e.emit("signin success",t))).catch((({responseText:t})=>e.emit("signin fail",t)))}},{event:"signup ajax request",callback:t=>{console.log(t),G.post({url:`${X}/signup`,body:t}).then((({responseText:t})=>e.emit("signup success",t))).catch((({responseText:t})=>e.emit("signup fail",t)))}},{event:"signout ajax request",callback:()=>{G.get({url:`${X}/logout`}).then((()=>e.emit("logout success"))).catch((e=>console.error(e)))}},{event:"profile ajax request",callback:()=>{G.get({url:`${X}/profile`}).then((()=>e.emit("authorization"))).catch((()=>e.emit("no authorization")))}},{event:"homepage ajax request",callback:()=>{G.get({url:`${X}/homepage`}).then((({responseText:t})=>e.emit("homepage response",t))).catch((e=>console.error(e)))}},{event:"product ajax request",callback:t=>{G.get({url:`${X}/product?id=${t}`}).then((({responseText:t})=>e.emit("product request success",{responseText:t}))).catch((({responseText:t})=>e.emit("product request fail",{responseText:t})))}},{event:"cart ajax request",callback:()=>{G.get({url:`${X}/cart`}).then((({responseText:t})=>e.emit("cart response",t))).catch((e=>console.error(e)))}},{event:"order ajax request",callback:()=>{G.get({url:`${X}/cart/confirm`}).then((({responseText:t})=>e.emit("order response",t))).catch((e=>console.error(e)))}},{event:"cookie check request",callback:()=>{G.get({url:`${X}/profile`}).then((({responseText:t})=>e.emit("cookie check success",t))).catch((({responseText:t})=>e.emit("cookie check fail",t)))}}],F={homepage:"homepage",signin:"signin",signup:"signup",profile:"profile",product:"product",logout:"homepage"},K=new class{root;constructor(){this.routes={}}set(e){this.root=e}register(e,t){return this.routes[e]={state:t},this}open(e){this.routes[e]||this.open("/")}hrefget=e=>{if(e instanceof HTMLAnchorElement)return e;const t=e.closest("a");return t&&this.root.contains(t)?t:void 0};urlHandler=e=>{const t=e.slice(1);return F[t]?F[t]:"homepage"};rout=()=>{const t=window.location.pathname,s=window.location.search;console.log(t);const n=(s.match(/\?id=(\d*)/)||[])[1],a=this.urlHandler(t);e.emit(`${a} state request`,n)};start(){console.log("router start"),this.root.addEventListener("click",(e=>{const t=this.hrefget(e.target);t&&(console.log(t.pathname),this.open(t.pathname))})),window.addEventListener("popstate",this.rout);const t=window.location.pathname;if(window.location.pathname!==t){const e={state:t};window.history.pushState(e,t,t)}e.emit("init")}},Q=[{event:"history add",callback:[e=>{console.log("hist add",e),console.log(window.location.pathname),console.log(window.location.search);let t=window.location.pathname.slice(1);const s=window.location.search;if(""!==s&&(t+=s),t!==e){const t={state:e};window.history.pushState(t,e,e)}}]},{event:"hood render finished",callback:[()=>{K.rout()}]}];e.add(U),e.add(_),e.on("init",(()=>{const n=document.getElementsByClassName("grid-container")[0],a=new j.Hood(n);return P({Hood:{element:a,dom:n,state:s}}),e.emit("cookie check request"),D.Hood.state=t,D.Hood.element.render().then((()=>e.emit("hood render finished")))})),"serviceWorker"in navigator&&navigator.serviceWorker.register("sw.js",{scope:"/"}).then((e=>{console.log("sw registration on scope:",e.scope)})).catch((e=>{console.error(e)}));const Y=document.getElementsByClassName("grid-container")[0];K.set(Y),e.add(Q),K.register("/","homepage").register("/homepage","homepage").register("/login","signin").register("/signup","signup").register("/profile","profile").register("/logout","signout").register("/product","product"),K.start(),console.log(window.location.pathname)})();